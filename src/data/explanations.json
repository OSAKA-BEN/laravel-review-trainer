[
  {
    "id": 1,
    "title": "Request Lifecycle in a Controller",
    "description": "Discover how Laravel processes an HTTP request through a REST controller, from validation to JSON response.",
    "level": "Beginner",
    "category": "Controllers",
    "code": "<?php\n\nnamespace App\\Http\\Controllers;\n\nuse App\\Models\\Article;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\JsonResponse;\n\nclass ArticleController extends Controller\n{\n    public function store(Request $request): JsonResponse\n    {\n        $validated = $request->validate([\n            'title' => 'required|string|max:255',\n            'body' => 'required|string',\n            'category_id' => 'required|exists:categories,id',\n            'tags' => 'nullable|array',\n            'tags.*' => 'integer|exists:tags,id',\n        ]);\n\n        $article = Article::create([\n            'title' => $validated['title'],\n            'body' => $validated['body'],\n            'category_id' => $validated['category_id'],\n            'user_id' => $request->user()->id,\n            'slug' => str($validated['title'])->slug(),\n        ]);\n\n        if (!empty($validated['tags'])) {\n            $article->tags()->attach($validated['tags']);\n        }\n\n        $article->load(['category', 'tags', 'user']);\n\n        return response()->json([\n            'message' => 'Article created successfully',\n            'data' => $article,\n        ], 201);\n    }\n}",
    "steps": [
      {
        "id": 1,
        "lines": [3],
        "title": "Namespace declaration",
        "explanation": "The namespace follows the PSR-4 convention. Laravel maps App\\Http\\Controllers to the app/Http/Controllers directory. Every controller lives in this namespace by convention.",
        "type": "info"
      },
      {
        "id": 2,
        "lines": [5, 6, 7],
        "title": "Importing dependencies",
        "explanation": "We import the Article model (Eloquent), the Request class that wraps the HTTP request, and JsonResponse to type the return value. Laravel automatically injects Request into the method via the Service Container.",
        "type": "info"
      },
      {
        "id": 3,
        "lines": [9],
        "title": "Extending the base Controller",
        "explanation": "The controller extends Laravel's base Controller class. This provides access to middleware, authorization, and utility methods. In Laravel 11+, this base class is optional.",
        "type": "info"
      },
      {
        "id": 4,
        "lines": [11],
        "title": "Store method with dependency injection",
        "explanation": "The store() method corresponds to a POST route. Laravel automatically injects the Request object via type-hinting. The return type is explicitly set to JsonResponse for clarity.",
        "type": "info"
      },
      {
        "id": 5,
        "lines": [13, 14, 15, 16, 17, 18, 19],
        "title": "Validating incoming data",
        "explanation": "validate() checks the request data against the defined rules. If validation fails, Laravel automatically returns a 422 response with error details. 'exists:categories,id' verifies the value exists in the database. 'tags.*' validates each element of the array.",
        "type": "warning"
      },
      {
        "id": 6,
        "lines": [21, 22, 23, 24, 25, 26],
        "title": "Creating the article via Eloquent",
        "explanation": "Article::create() uses mass assignment. Only fields listed in the model's $fillable property will be filled. We add user_id from the authenticated user and generate a slug from the title using the str() helper.",
        "type": "info"
      },
      {
        "id": 7,
        "lines": [25],
        "title": "Accessing the authenticated user",
        "explanation": "$request->user() returns the currently authenticated user instance (via the auth middleware). This is equivalent to auth()->user(). If no user is logged in, it returns null — so make sure the route is protected by the auth middleware.",
        "type": "warning"
      },
      {
        "id": 8,
        "lines": [28, 29, 30],
        "title": "Attaching many-to-many relations",
        "explanation": "attach() adds records to the pivot table (article_tag). We first check that tags were provided. The attach method accepts an array of IDs and creates the corresponding rows in the pivot table.",
        "type": "info"
      },
      {
        "id": 9,
        "lines": [32],
        "title": "Eager loading relations",
        "explanation": "load() fetches the relations after creation to include them in the JSON response. Without this, the relations would not be present in the output. This is lazy eager loading — the SQL queries are executed at this point.",
        "type": "tip"
      },
      {
        "id": 10,
        "lines": [34, 35, 36, 37],
        "title": "JSON response with 201 status",
        "explanation": "response()->json() creates a JSON response. The HTTP 201 (Created) status code indicates a resource was successfully created. The article is automatically converted to JSON via Eloquent's toArray() method.",
        "type": "info"
      }
    ]
  },
  {
    "id": 2,
    "title": "Eloquent Model: Relations, Scopes & Accessors",
    "description": "Explore a complete Eloquent model with its relationships, query scopes, accessors, and attribute casting.",
    "level": "Intermediate",
    "category": "Models",
    "code": "<?php\n\nnamespace App\\Models;\n\nuse Illuminate\\Database\\Eloquent\\Model;\nuse Illuminate\\Database\\Eloquent\\SoftDeletes;\nuse Illuminate\\Database\\Eloquent\\Relations\\BelongsTo;\nuse Illuminate\\Database\\Eloquent\\Relations\\HasMany;\nuse Illuminate\\Database\\Eloquent\\Builder;\nuse Illuminate\\Database\\Eloquent\\Casts\\Attribute;\n\nclass Product extends Model\n{\n    use SoftDeletes;\n\n    protected $fillable = [\n        'name',\n        'description',\n        'price',\n        'stock_quantity',\n        'category_id',\n        'is_active',\n    ];\n\n    protected $casts = [\n        'price' => 'decimal:2',\n        'is_active' => 'boolean',\n        'metadata' => 'array',\n    ];\n\n    protected $appends = ['formatted_price', 'is_in_stock'];\n\n    // --- Relations ---\n\n    public function category(): BelongsTo\n    {\n        return $this->belongsTo(Category::class);\n    }\n\n    public function reviews(): HasMany\n    {\n        return $this->hasMany(Review::class)->latest();\n    }\n\n    public function orderItems(): HasMany\n    {\n        return $this->hasMany(OrderItem::class);\n    }\n\n    // --- Scopes ---\n\n    public function scopeActive(Builder $query): Builder\n    {\n        return $query->where('is_active', true);\n    }\n\n    public function scopeInStock(Builder $query): Builder\n    {\n        return $query->where('stock_quantity', '>', 0);\n    }\n\n    public function scopePriceBetween(Builder $query, float $min, float $max): Builder\n    {\n        return $query->whereBetween('price', [$min, $max]);\n    }\n\n    // --- Accessors ---\n\n    protected function formattedPrice(): Attribute\n    {\n        return Attribute::make(\n            get: fn () => number_format($this->price, 2, ',', ' ') . ' EUR',\n        );\n    }\n\n    protected function isInStock(): Attribute\n    {\n        return Attribute::make(\n            get: fn () => $this->stock_quantity > 0,\n        );\n    }\n\n    // --- Methods ---\n\n    public function decrementStock(int $quantity = 1): bool\n    {\n        if ($this->stock_quantity < $quantity) {\n            return false;\n        }\n\n        $this->decrement('stock_quantity', $quantity);\n\n        return true;\n    }\n}",
    "steps": [
      {
        "id": 1,
        "lines": [5, 6, 7, 8, 9, 10],
        "title": "Model imports",
        "explanation": "We import Model (the Eloquent base class), SoftDeletes (for soft deletion), relationship types (BelongsTo, HasMany), Builder (to type scopes), and Attribute (for the new accessor syntax introduced in Laravel 9+).",
        "type": "info"
      },
      {
        "id": 2,
        "lines": [14],
        "title": "SoftDeletes trait",
        "explanation": "SoftDeletes enables soft deletion: instead of removing the row from the database, Laravel sets the deleted_at column. Eloquent queries automatically exclude soft-deleted records. You can retrieve them with withTrashed().",
        "type": "info"
      },
      {
        "id": 3,
        "lines": [16, 17, 18, 19, 20, 21, 22, 23],
        "title": "Mass assignment with $fillable",
        "explanation": "$fillable defines which fields can be filled via create() or update(). This is a protection against mass assignment attacks: if a user sends an unlisted field (e.g. 'is_admin'), it will be ignored. The alternative is $guarded, which lists forbidden fields instead.",
        "type": "warning"
      },
      {
        "id": 4,
        "lines": [25, 26, 27, 28, 29],
        "title": "Automatic attribute casting",
        "explanation": "$casts automatically converts attributes to the specified type. 'decimal:2' ensures 2 decimal places, 'boolean' converts 0/1 to true/false, 'array' auto-encodes/decodes JSON. Casts are applied on both read AND write operations.",
        "type": "tip"
      },
      {
        "id": 5,
        "lines": [31],
        "title": "Appended attributes",
        "explanation": "$appends adds computed attributes (accessors) to the model's JSON serialization. Without $appends, the formatted_price and is_in_stock accessors would not be included in toArray() or toJson() output.",
        "type": "info"
      },
      {
        "id": 6,
        "lines": [35, 36, 37],
        "title": "BelongsTo relationship",
        "explanation": "belongsTo() defines an inverse relationship: a Product belongs to a Category. Laravel automatically looks for the category_id column in the products table. You can access the category via $product->category.",
        "type": "info"
      },
      {
        "id": 7,
        "lines": [40, 41, 42],
        "title": "HasMany relationship with ordering",
        "explanation": "hasMany() indicates a product has many reviews. Chaining ->latest() sorts reviews by creation date in descending order by default. It's a shortcut for orderBy('created_at', 'desc').",
        "type": "info"
      },
      {
        "id": 8,
        "lines": [53, 54, 55],
        "title": "Local scope: active()",
        "explanation": "Local scopes allow you to reuse query conditions. You can chain them: Product::active()->inStock()->get(). The 'scope' prefix is removed when calling. The scope receives and returns a Builder for chaining.",
        "type": "tip"
      },
      {
        "id": 9,
        "lines": [62, 63, 64],
        "title": "Parameterized scope",
        "explanation": "A scope can accept parameters after the Builder. Usage: Product::priceBetween(10, 50)->get(). whereBetween generates a SQL BETWEEN clause to filter by price range.",
        "type": "info"
      },
      {
        "id": 10,
        "lines": [68, 69, 70, 71, 72],
        "title": "Accessor with new syntax",
        "explanation": "Since Laravel 9, accessors use Attribute::make(). The get callback defines the value returned when accessing $product->formatted_price. Here we format the price in euros with French-style separators.",
        "type": "info"
      },
      {
        "id": 11,
        "lines": [74, 75, 76, 77, 78],
        "title": "Computed boolean accessor",
        "explanation": "This accessor returns true/false based on stock level. Combined with $appends, it will be present in every JSON response. Useful so the frontend can display 'In stock' / 'Out of stock' without recalculating.",
        "type": "tip"
      },
      {
        "id": 12,
        "lines": [82, 83, 84, 85, 86, 87, 88, 89, 90],
        "title": "Business method with guard clause",
        "explanation": "decrementStock() encapsulates business logic. It first checks that stock is sufficient, then uses decrement() which executes an atomic SQL query (UPDATE SET stock_quantity = stock_quantity - N). This avoids race conditions compared to $this->stock_quantity -= $quantity followed by save().",
        "type": "warning"
      }
    ]
  },
  {
    "id": 3,
    "title": "Custom Middleware: Authentication & Authorization",
    "description": "Understand how a custom middleware intercepts requests to verify user permissions and roles.",
    "level": "Intermediate",
    "category": "Middleware",
    "files": [
      {
        "name": "EnsureUserHasRole.php",
        "code": "<?php\n\nnamespace App\\Http\\Middleware;\n\nuse Closure;\nuse Illuminate\\Http\\Request;\nuse Symfony\\Component\\HttpFoundation\\Response;\n\nclass EnsureUserHasRole\n{\n    public function handle(Request $request, Closure $next, string ...$roles): Response\n    {\n        $user = $request->user();\n\n        if (!$user) {\n            return response()->json([\n                'message' => 'Authentication required',\n            ], 401);\n        }\n\n        if (!in_array($user->role, $roles)) {\n            return response()->json([\n                'message' => 'Insufficient permissions',\n                'required_roles' => $roles,\n                'current_role' => $user->role,\n            ], 403);\n        }\n\n        return $next($request);\n    }\n}"
      },
      {
        "name": "routes/api.php",
        "code": "<?php\n\nuse Illuminate\\Support\\Facades\\Route;\nuse App\\Http\\Controllers\\AdminController;\nuse App\\Http\\Controllers\\ArticleController;\n\nRoute::middleware(['auth:sanctum'])->group(function () {\n\n    Route::get('/articles', [ArticleController::class, 'index']);\n    Route::post('/articles', [ArticleController::class, 'store']);\n\n    Route::middleware(['role:admin,editor'])->group(function () {\n        Route::put('/articles/{article}', [ArticleController::class, 'update']);\n        Route::delete('/articles/{article}', [ArticleController::class, 'destroy']);\n    });\n\n    Route::middleware(['role:admin'])->group(function () {\n        Route::get('/admin/dashboard', [AdminController::class, 'index']);\n        Route::post('/admin/users', [AdminController::class, 'store']);\n    });\n});"
      }
    ],
    "steps": [
      {
        "id": 1,
        "file": "EnsureUserHasRole.php",
        "lines": [5, 6, 7],
        "title": "Middleware dependencies",
        "explanation": "Closure represents the next link in the middleware chain. Request wraps the HTTP request. Response (from Symfony, used by Laravel) types the returned response.",
        "type": "info"
      },
      {
        "id": 2,
        "file": "EnsureUserHasRole.php",
        "lines": [11],
        "title": "handle() with variadic parameters",
        "explanation": "handle() is the middleware's main method. The string ...$roles parameter uses the splat operator to accept a variable number of roles. When you write role:admin,editor in routes, Laravel passes 'admin' and 'editor' as separate arguments.",
        "type": "info"
      },
      {
        "id": 3,
        "file": "EnsureUserHasRole.php",
        "lines": [13],
        "title": "Retrieving the authenticated user",
        "explanation": "$request->user() returns the authenticated user or null. The auth:sanctum middleware (applied upstream in routes) has already attempted authentication, but it may have failed if the token is invalid.",
        "type": "info"
      },
      {
        "id": 4,
        "file": "EnsureUserHasRole.php",
        "lines": [15, 16, 17, 18, 19],
        "title": "Authentication check",
        "explanation": "If no user is authenticated, we return a 401 (Unauthorized) response. By returning a response here instead of calling $next(), we short-circuit the pipeline: the request never reaches the controller.",
        "type": "warning"
      },
      {
        "id": 5,
        "file": "EnsureUserHasRole.php",
        "lines": [21, 22, 23, 24, 25, 26, 27],
        "title": "Role verification",
        "explanation": "in_array() checks whether the user's role is among the allowed roles. If not, we return a 403 (Forbidden) response with debugging details. In production, you might want to hide current_role for security reasons.",
        "type": "warning"
      },
      {
        "id": 6,
        "file": "EnsureUserHasRole.php",
        "lines": [29],
        "title": "Passing to the next middleware",
        "explanation": "$next($request) passes the request to the next middleware in the stack, or to the controller if this is the last one. This is the chain of responsibility pattern: each middleware decides whether to let the request through or block it.",
        "type": "tip"
      },
      {
        "id": 7,
        "file": "routes/api.php",
        "lines": [7],
        "title": "Route group with authentication",
        "explanation": "middleware(['auth:sanctum']) protects all routes in this group. Sanctum is Laravel's API authentication system (tokens). Any request without a valid token will receive a 401 response before even reaching our role middleware.",
        "type": "info"
      },
      {
        "id": 8,
        "file": "routes/api.php",
        "lines": [9, 10],
        "title": "Authenticated routes without role restriction",
        "explanation": "These routes require authentication (via auth:sanctum) but have no role restriction. Any logged-in user can list and create articles.",
        "type": "info"
      },
      {
        "id": 9,
        "file": "routes/api.php",
        "lines": [12, 13, 14, 15],
        "title": "Routes restricted to admins and editors",
        "explanation": "The role:admin,editor middleware allows users with either the 'admin' OR 'editor' role. Commas separate the allowed roles, which are passed as variadic arguments to handle(). Updating and deleting articles requires a specific role.",
        "type": "info"
      },
      {
        "id": 10,
        "file": "routes/api.php",
        "lines": [17, 18, 19, 20],
        "title": "Admin-only routes",
        "explanation": "This group only allows the 'admin' role. Middleware stack up: auth:sanctum (authentication) then role:admin (authorization). If either fails, the request is rejected. This is the principle of defense in depth.",
        "type": "warning"
      }
    ]
  }
]
